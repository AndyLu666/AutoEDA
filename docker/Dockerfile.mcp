FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    netcat-openbsd \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY server/mcp/ ./server/mcp/
COPY server/ ./server/
COPY scripts/ ./scripts/
COPY config/ ./config/
COPY designs/ ./designs/
COPY libraries/ ./libraries/
COPY exp_v1/ ./exp_v1/
COPY simple_mcp_client.py ./
COPY mcp_agent_client.py ./

# Create necessary directories
RUN mkdir -p logs deliverables

# Create startup script for MCP server
RUN echo '#!/bin/bash\n\
echo "=== MCP EDA Server Starting (Updated 4-Server Architecture) ==="\n\
echo "Python version: $(python3 --version)"\n\
echo "Working directory: $(pwd)"\n\
echo "Available files in server/mcp: $(ls -la server/mcp/)"\n\
echo ""\n\
echo "MCP Server Configuration:"\n\
echo "- Mode: stdio (for Claude Desktop integration)"\n\
echo "- EDA Servers: synth(13333), unified_placement(13340), cts(13338), unified_route_save(13341)"\n\
echo "- Legacy compatibility: enabled"\n\
echo ""\n\
echo "Starting MCP EDA Server..."\n\
cd server/mcp\n\
exec python3 mcp_eda_server.py\n\
' > /app/start_mcp_server.sh && chmod +x /app/start_mcp_server.sh

# Note: MCP server runs in stdio mode for Claude Desktop, not HTTP mode
# No port exposure needed for stdio mode

# Health check - verify MCP server can import and EDA servers are reachable
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD python3 -c "import sys; sys.path.append('/app/server/mcp'); import mcp_eda_server; print('MCP server dependencies OK')" || exit 1

# Start the MCP EDA server in stdio mode
CMD ["/app/start_mcp_server.sh"] 